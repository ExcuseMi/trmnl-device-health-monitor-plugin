<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRMNL Health Monitor - Data Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin-bottom: 15px;
            color: #333;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
            min-width: 300px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .device-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .device-card.stale {
            opacity: 0.6;
            background: repeating-linear-gradient(
                45deg,
                #fff,
                #fff 10px,
                #f9f9f9 10px,
                #f9f9f9 20px
            );
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .device-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .device-id {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .field-group {
            margin-bottom: 10px;
        }

        .field-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .field-value {
            font-size: 14px;
            color: #333;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .field-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .device-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            display: flex;
            gap: 10px;
        }

        .device-actions button {
            flex: 1;
            font-size: 12px;
            padding: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: #666;
        }

        .empty-state p {
            color: #999;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ðŸ“Š TRMNL Health Monitor - Data Editor</h1>
            <div class="header-controls">
                <input type="text" id="pluginUuid" placeholder="Enter your TRMNL plugin UUID">
                <button class="btn-primary" onclick="loadData()">
                    <span id="loadBtnText">Load Data</span>
                </button>
                <button class="btn-success" onclick="saveAllData()" id="saveBtn" disabled>
                    Save Changes
                </button>
                <button class="btn-secondary" onclick="showRawData()">
                    View Raw JSON
                </button>
            </div>
            <div class="stats" id="stats" style="display: none;">
                <div class="stat">
                    <div class="stat-value" id="deviceCount">0</div>
                    <div class="stat-label">Devices</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="activeCount">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="staleCount">0</div>
                    <div class="stat-label">Stale</div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="message success" id="successMsg"></div>
        <div class="message error" id="errorMsg"></div>
        <div class="message info" id="infoMsg"></div>

        <!-- Devices Grid -->
        <div class="devices-grid" id="devicesGrid">
            <div class="empty-state">
                <h2>No Data Loaded</h2>
                <p>Enter your Plugin UUID above and click "Load Data" to get started</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">Edit Device</div>
            <form id="editForm">
                <div class="form-group">
                    <label>Device Name</label>
                    <input type="text" id="edit_name" required>
                </div>
                <div class="form-group">
                    <label>OS</label>
                    <input type="text" id="edit_os">
                </div>
                <div class="form-group">
                    <label>User Count</label>
                    <input type="number" id="edit_user_count" min="0">
                </div>
                <div class="form-group">
                    <label>Users (comma-separated)</label>
                    <input type="text" id="edit_users">
                </div>
                <div class="form-group">
                    <label>CPU %</label>
                    <input type="number" id="edit_cpu" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>CPU Cores</label>
                    <input type="number" id="edit_cores" min="1">
                </div>
                <div class="form-group">
                    <label>CPU Frequency (MHz)</label>
                    <input type="number" id="edit_freq" min="0">
                </div>
                <div class="form-group">
                    <label>Memory Used (GB)</label>
                    <input type="number" id="edit_mem_used" min="0">
                </div>
                <div class="form-group">
                    <label>Memory Total (GB)</label>
                    <input type="number" id="edit_mem_total" min="1">
                </div>
                <div class="form-group">
                    <label>Disk Used (GB)</label>
                    <input type="number" id="edit_disk_used" min="0">
                </div>
                <div class="form-group">
                    <label>Disk Total (GB)</label>
                    <input type="number" id="edit_disk_total" min="1">
                </div>
                <div class="form-group">
                    <label>Temperature (Â°C)</label>
                    <input type="number" id="edit_temp" min="0">
                </div>
                <div class="form-group">
                    <label>Battery %</label>
                    <input type="number" id="edit_battery" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Charging</label>
                    <select id="edit_charging" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="0">No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Connection (e.g., wifi:HomeNet or lan)</label>
                    <input type="text" id="edit_connection">
                </div>
                <div class="form-group">
                    <label>IP Address</label>
                    <input type="text" id="edit_ip">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Raw JSON Modal -->
    <div class="modal" id="rawModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">Raw JSON Data</div>
            <pre id="rawJson" style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 400px;"></pre>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeRawModal()">Close</button>
                <button type="button" class="btn-primary" onclick="copyRawJson()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};
        let currentPluginUuid = '';
        let editingDeviceId = null;

        function showMessage(type, message) {
            const msgEl = document.getElementById(type + 'Msg');
            msgEl.textContent = message;
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 5000);
        }

        async function loadData() {
            const pluginUuid = document.getElementById('pluginUuid').value.trim();
            if (!pluginUuid) {
                showMessage('error', 'Please enter a Plugin UUID');
                return;
            }

            currentPluginUuid = pluginUuid;
            const loadBtn = document.getElementById('loadBtnText');
            loadBtn.textContent = 'Loading...';

            try {
                const response = await fetch(`https://usetrmnl.com/api/custom_plugins/${pluginUuid}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                currentData = data.merge_variables || {};

                renderDevices();
                updateStats();
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('stats').style.display = 'flex';
                showMessage('success', `Loaded ${Object.keys(currentData).length} devices`);
            } catch (error) {
                showMessage('error', `Error loading data: ${error.message}`);
            } finally {
                loadBtn.textContent = 'Load Data';
            }
        }

        function parseDevice(deviceKey, rawData) {
            const fields = rawData.split('|');
            const now = Math.floor(Date.now() / 1000);
            const timestamp = parseInt(fields[22] || 0);
            const isStale = (now - timestamp) > 7200;

            return {
                key: deviceKey,
                id: deviceKey.substring(1),
                name: fields[0] || 'Unknown',
                os: fields[1] || '',
                user_count: fields[2] || '0',
                users: fields[3] || 'none',
                cpu: fields[4] || '0',
                cores: fields[5] || '0',
                freq: fields[6] || '0',
                load: fields[7] || '0,0,0',
                mem_used: fields[8] || '0',
                mem_total: fields[9] || '0',
                disk_used: fields[10] || '0',
                disk_total: fields[11] || '0',
                temp: fields[12] || '0',
                battery: fields[13] || '0',
                charging: fields[14] || '0',
                gpu: fields[15] || 'none',
                gpu_temp: fields[16] || '0',
                gpu_util: fields[17] || '0',
                network: fields[18] || '0',
                connection: fields[19] || 'lan',
                ip: fields[20] || '0.0.0.0',
                uptime: fields[21] || '0',
                timestamp: timestamp,
                isStale: isStale,
                raw: rawData
            };
        }

        function renderDevices() {
            const grid = document.getElementById('devicesGrid');

            if (Object.keys(currentData).length === 0) {
                grid.innerHTML = '<div class="empty-state"><h2>No Devices Found</h2><p>No device data in this plugin</p></div>';
                return;
            }

            const devices = Object.keys(currentData)
                .filter(key => key.startsWith('d'))
                .sort((a, b) => parseInt(a.substring(1)) - parseInt(b.substring(1)))
                .map(key => parseDevice(key, currentData[key]));

            grid.innerHTML = devices.map(device => {
                const memPct = Math.round((device.mem_used / device.mem_total) * 100);
                const diskPct = Math.round((device.disk_used / device.disk_total) * 100);
                const uptimeHours = Math.floor(device.uptime / 3600);
                const uptimeDisplay = uptimeHours > 24 ? `${Math.floor(uptimeHours / 24)}d` : `${uptimeHours}h`;

                let staleLabel = '';
                if (device.isStale) {
                    const hoursAgo = Math.floor((Math.floor(Date.now() / 1000) - device.timestamp) / 3600);
                    staleLabel = hoursAgo > 24 ? `${Math.floor(hoursAgo / 24)}d ago` : `${hoursAgo}h ago`;
                }

                return `
                    <div class="device-card ${device.isStale ? 'stale' : ''}">
                        <div class="device-header">
                            <div class="device-title">${device.name}</div>
                            <div class="device-id">${device.key}</div>
                        </div>
                        ${device.isStale ? `<div class="badge badge-warning">Stale: ${staleLabel}</div>` : '<div class="badge badge-success">Active</div>'}

                        <div class="field-group">
                            <div class="field-label">OS & Users</div>
                            <div class="field-value">${device.os} Â· ${device.user_count} user(s)</div>
                        </div>

                        <div class="field-grid">
                            <div class="field-group">
                                <div class="field-label">CPU</div>
                                <div class="field-value">${device.cpu}%</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Cores @ Freq</div>
                                <div class="field-value">${device.cores} @ ${device.freq}MHz</div>
                            </div>
                        </div>

                        <div class="field-grid">
                            <div class="field-group">
                                <div class="field-label">RAM</div>
                                <div class="field-value">${device.mem_used}/${device.mem_total}GB (${memPct}%)</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Disk</div>
                                <div class="field-value">${device.disk_used}/${device.disk_total}GB (${diskPct}%)</div>
                            </div>
                        </div>

                        <div class="field-grid">
                            <div class="field-group">
                                <div class="field-label">Temp</div>
                                <div class="field-value">${device.temp}Â°C</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Battery</div>
                                <div class="field-value">${device.battery}% ${device.charging == '1' ? 'âš¡' : ''}</div>
                            </div>
                        </div>

                        <div class="field-grid">
                            <div class="field-group">
                                <div class="field-label">Network</div>
                                <div class="field-value">${device.connection}</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">IP</div>
                                <div class="field-value">${device.ip}</div>
                            </div>
                        </div>

                        <div class="field-group">
                            <div class="field-label">Uptime</div>
                            <div class="field-value">${uptimeDisplay}</div>
                        </div>

                        <div class="device-actions">
                            <button class="btn-primary" onclick="editDevice('${device.key}')">Edit</button>
                            <button class="btn-danger" onclick="deleteDevice('${device.key}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const devices = Object.keys(currentData).filter(k => k.startsWith('d'));
            const now = Math.floor(Date.now() / 1000);

            let active = 0, stale = 0;
            devices.forEach(key => {
                const fields = currentData[key].split('|');
                const timestamp = parseInt(fields[22] || 0);
                if ((now - timestamp) > 7200) {
                    stale++;
                } else {
                    active++;
                }
            });

            document.getElementById('deviceCount').textContent = devices.length;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('staleCount').textContent = stale;
        }

        function editDevice(deviceKey) {
            const device = parseDevice(deviceKey, currentData[deviceKey]);
            editingDeviceId = deviceKey;

            document.getElementById('edit_name').value = device.name;
            document.getElementById('edit_os').value = device.os;
            document.getElementById('edit_user_count').value = device.user_count;
            document.getElementById('edit_users').value = device.users;
            document.getElementById('edit_cpu').value = device.cpu;
            document.getElementById('edit_cores').value = device.cores;
            document.getElementById('edit_freq').value = device.freq;
            document.getElementById('edit_mem_used').value = device.mem_used;
            document.getElementById('edit_mem_total').value = device.mem_total;
            document.getElementById('edit_disk_used').value = device.disk_used;
            document.getElementById('edit_disk_total').value = device.disk_total;
            document.getElementById('edit_temp').value = device.temp;
            document.getElementById('edit_battery').value = device.battery;
            document.getElementById('edit_charging').value = device.charging;
            document.getElementById('edit_connection').value = device.connection;
            document.getElementById('edit_ip').value = device.ip;

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingDeviceId = null;
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!editingDeviceId) return;

            const device = parseDevice(editingDeviceId, currentData[editingDeviceId]);

            // Rebuild payload with edited values
            const newPayload = [
                document.getElementById('edit_name').value,
                document.getElementById('edit_os').value,
                document.getElementById('edit_user_count').value,
                document.getElementById('edit_users').value,
                document.getElementById('edit_cpu').value,
                document.getElementById('edit_cores').value,
                document.getElementById('edit_freq').value,
                device.load, // Keep existing load
                document.getElementById('edit_mem_used').value,
                document.getElementById('edit_mem_total').value,
                document.getElementById('edit_disk_used').value,
                document.getElementById('edit_disk_total').value,
                document.getElementById('edit_temp').value,
                document.getElementById('edit_battery').value,
                document.getElementById('edit_charging').value,
                device.gpu, // Keep existing GPU
                device.gpu_temp,
                device.gpu_util,
                device.network, // Keep existing network
                document.getElementById('edit_connection').value,
                document.getElementById('edit_ip').value,
                device.uptime, // Keep existing uptime
                Math.floor(Date.now() / 1000) // Update timestamp
            ].join('|');

            currentData[editingDeviceId] = newPayload;
            renderDevices();
            updateStats();
            closeEditModal();
            showMessage('info', 'Changes saved locally. Click "Save Changes" to update TRMNL.');
        });

        async function saveAllData() {
            if (!currentPluginUuid) {
                showMessage('error', 'No plugin UUID set');
                return;
            }

            if (!confirm('Save all changes to TRMNL?')) return;

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`https://usetrmnl.com/api/custom_plugins/${currentPluginUuid}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merge_variables: currentData })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                showMessage('success', 'All changes saved to TRMNL!');
            } catch (error) {
                showMessage('error', `Error saving: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        async function deleteDevice(deviceKey) {
            if (!confirm(`Delete device ${deviceKey}? This will remove it from TRMNL.`)) return;

            delete currentData[deviceKey];

            try {
                const response = await fetch(`https://usetrmnl.com/api/custom_plugins/${currentPluginUuid}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merge_variables: currentData })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                renderDevices();
                updateStats();
                showMessage('success', `Device ${deviceKey} deleted`);
            } catch (error) {
                showMessage('error', `Error deleting: ${error.message}`);
            }
        }

        function showRawData() {
            document.getElementById('rawJson').textContent = JSON.stringify({ merge_variables: currentData }, null, 2);
            document.getElementById('rawModal').classList.add('active');
        }

        function closeRawModal() {
            document.getElementById('rawModal').classList.remove('active');
        }

        function copyRawJson() {
            const text = document.getElementById('rawJson').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showMessage('success', 'JSON copied to clipboard!');
            });
        }
    </script>
</body>
</html>